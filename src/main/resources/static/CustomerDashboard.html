<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Dashboard - SBS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --font-size: 16px;
            --animation-speed: 0.3s;
            --notification-bg: #10b981;
            --notification-text: #ffffff;
            --card-border-style: solid;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-pattern, linear-gradient(135deg, var(--bg-primary, #1f2937), var(--bg-secondary, #374151)));
            color: var(--text-color, #e5e7eb);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: var(--font-size);
            transition: all var(--animation-speed) ease;
        }

        .navbar {
            background: linear-gradient(to right, var(--nav-bg-start, #111827), var(--nav-bg-end, #1e40af));
            color: var(--text-color, #ffffff);
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .navbar h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 1px;
            animation: fadeInDown 1s ease-in-out;
        }

        .customize-btn {
            position: relative;
            background: linear-gradient(to right, var(--btn-start, #3b82f6), var(--btn-end, #2563eb));
            transition: transform var(--animation-speed) ease, background var(--animation-speed) ease;
        }

        .customize-btn:hover::after {
            content: 'Customize Dashboard';
            position: absolute;
            top: -2.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            padding: 2.5rem;
            max-width: 1400px;
            margin: 0 auto;
            transition: filter var(--animation-speed) ease;
        }

        .container.blur,
        .navbar.blur {
            filter: blur(5px);
        }

        .container.disabled,
        .navbar.disabled {
            pointer-events: none;
        }

        .card {
            background: var(--card-bg, #1f2937);
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            padding: 2rem;
            transition: transform var(--animation-speed) ease, box-shadow var(--animation-speed) ease;
            position: relative;
            overflow: hidden;
            cursor: move;
            border: 2px var(--card-border-style, solid) var(--accent-start, #3b82f6);
        }

        .card.hidden {
            display: none;
        }

        .card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .card.lift:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }

        .card.scale:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }

        .card.rotate:hover {
            transform: rotate(2deg);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--accent-start, #3b82f6), var(--accent-end, #10b981));
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color, #ffffff);
            margin: 0 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card p {
            color: var(--text-secondary, #d1d5db);
            font-size: 1rem;
            margin: 0.5rem 0;
        }

        .card p strong,
        .card p span {
            color: var(--text-color, #e5e7eb);
        }

        .btn {
            background: linear-gradient(to right, var(--btn-start, #3b82f6), var(--btn-end, #2563eb));
            color: var(--text-color, #ffffff);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all var(--animation-speed) ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: linear-gradient(to right, var(--btn-hover-start, #2563eb), var(--btn-hover-end, #1e40af));
            transform: scale(1.05);
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid var(--border-color, #4b5563);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--input-bg, #374151);
            color: var(--text-color, #e5e7eb);
            transition: border-color var(--animation-speed) ease;
        }

        select {
            background: var(--input-bg, #374151);
            color: var(--text-color, #e5e7eb);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="var(--text-color, %23e5e7eb)"><path d="M7 7l3-3 3 3m0 6l-3 3-3-3"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-start, #3b82f6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        input::placeholder {
            color: var(--placeholder-color, #9ca3af);
        }

        .logout-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--logout-bg, #dc2626);
        }

        .balance {
            font-size: 2rem;
            font-weight: 700;
            color: var(--balance-color, #10b981);
            animation: pulse 2s infinite;
        }

        .transaction-card,
        .customization-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--card-bg, #1f2937);
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            padding: 2rem;
            z-index: 100;
            overflow-y: auto;
            animation: fadeIn var(--animation-speed) ease-in;
            display: none;
        }

        .transaction-card {
            resize: both;
            overflow: auto;
            min-width: 400px;
            min-height: 300px;
            max-width: 90vw;
            max-height: 90vh;
            position: fixed;
            z-index: 100;
        }

        .transaction-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23e5e7eb" stroke-width="2"><path d="M16 16h6v6h-6z"/></svg>') no-repeat center;
            cursor: se-resize;
        }

        .transaction-card.active,
        .customization-panel.active {
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .modal-overlay.active {
            display: block;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: var(--tab-bg, #374151);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: background var(--animation-speed) ease;
        }

        .tab.active {
            background: var(--accent-start, #3b82f6);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .transaction-table th,
        .transaction-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color, #4b5563);
            color: var(--text-color, #e5e7eb);
            font-size: 0.9rem;
            vertical-align: middle;
        }

        .transaction-table th {
            background: var(--table-header-bg, #374151);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .transaction-table td {
            word-break: break-word;
        }

        .transaction-table tr:hover {
            background: var(--table-row-hover, #2d3748);
        }

        .transaction-table th:nth-child(1) { width: 5%; }
        .transaction-table th:nth-child(2) { width: 15%; }
        .transaction-table th:nth-child(3) { width: 15%; }
        .transaction-table th:nth-child(4) { width: 15%; }
        .transaction-table th:nth-child(5) { width: 10%; }
        .transaction-table th:nth-child(6) { width: 15%; }
        .transaction-table th:nth-child(7) { width: 10%; }
        .transaction-table th:nth-child(8) { width: 15%; }

        .close-btn {
            background: var(--logout-bg, #dc2626);
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .email-btn {
            background: linear-gradient(to right, var(--email-btn-start, #10b981), var(--email-btn-end, #059669));
            margin-top: 1rem;
        }

        .chart-btn {
            background: linear-gradient(to right, var(--chart-btn-start, #8b5cf6), var(--chart-btn-end, #6d28d9));
            margin-top: 1rem;
            margin-left: 1rem;
        }

        #transactionChart {
            max-height: 300px;
            margin-top: 1rem;
            display: none;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--notification-bg, #10b981);
            color: var(--notification-text, #ffffff);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.5s ease forwards;
        }

        .notification.active {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading Bar Styles */
        .loading-bar-container {
            position: relative;
            width: 100%;
            height: 8px;
            background: var(--input-bg, #374151);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
            display: none;
        }

        .loading-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                var(--accent-start, #3b82f6) 0%,
                var(--accent-end, #10b981) 50%,
                var(--accent-start, #3b82f6) 100%
            );
            background-size: 200% 100%;
            animation: loadingAnimation 1.5s linear infinite;
            border-radius: 4px;
        }

        @keyframes loadingAnimation {
            0% { background-position: 200% 0; }
            100% { background-position: 0 0; }
        }

        /* Animations */
        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1.5rem;
            }

            .navbar h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 1.5rem;
            }

            .transaction-card {
                resize: none;
            }

            .transaction-card::after {
                display: none;
            }

            .transaction-table {
                font-size: 0.8rem;
            }

            .transaction-table th,
            .transaction-table td {
                padding: 0.5rem;
            }

            .transaction-table th:nth-child(1) { width: 8%; }
            .transaction-table th:nth-child(2) { width: 20%; }
            .transaction-table th:nth-child(3) { width: 20%; }
            .transaction-table th:nth-child(4) { width: 20%; }
            .transaction-table th:nth-child(5) { width: 12%; }
            .transaction-table th:nth-child(6) { width: 20%; }
            .transaction-table th:nth-child(7) { width: 12%; }
            .transaction-table th:nth-child(8) { width: 18%; }
        }
    </style>
</head>
<body>
<div class="navbar" id="navbar">
    <h1>Welcome to SBS - Customer Dashboard</h1>
    <button class="btn customize-btn" onclick="openCustomizationPanel()">
        <i class="fas fa-cog fa-spin"></i>
    </button>
    <button class="btn logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>

<div class="container" id="mainContainer">
    <div class="card lift" draggable="true" data-id="account-details">
        <h2><i class="fas fa-user-circle"></i> Account Details</h2>
        <p><strong>Account Number:</strong> <span id="accountNumber"></span></p>
        <p><strong>Name:</strong> <span id="name"></span></p>
        <p><strong>Email:</strong> <span id="email"></span></p>
        <p><strong>Phone:</strong> <span id="phone"></span></p>
    </div>

    <div class="card lift" draggable="true" data-id="current-balance">
        <h2><i class="fas fa-wallet"></i> Current Balance</h2>
        <p><strong>₹</strong> <span id="balance" class="balance">Loading...</span></p>
    </div>

    <div class="card lift" draggable="true" data-id="quick-actions">
        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
        <input type="number" id="amount" placeholder="Amount (₹)" />
        <button class="btn" onclick="deposit()"><i class="fas fa-plus-circle"></i> Deposit</button>
        <button class="btn" onclick="withdraw()"><i class="fas fa-minus-circle"></i> Withdraw</button>
    </div>

    <div class="card lift" draggable="true" data-id="transfer-funds">
        <h2><i class="fas fa-exchange-alt"></i> Transfer Funds</h2>
        <input type="text" id="toAccount" placeholder="To Account Number" />
        <input type="number" id="transferAmount" placeholder="Amount (₹)" />
        <button class="btn" onclick="transfer()"><i class="fas fa-paper-plane"></i> Transfer</button>
    </div>

    <div class="card lift" draggable="true" data-id="mini-statement">
        <h2><i class="fas fa-file-invoice-dollar"></i> Mini Statement</h2>
        <input type="date" id="fromDate" placeholder="From Date" />
        <input type="date" id="toDate" placeholder="To Date" />
        <button class="btn" onclick="fetchMiniStatement()"><i class="fas fa-search"></i> Fetch Transactions</button>
        <ul id="miniStatement" class="text-sm space-y-2 mt-2 text-gray-300"></ul>
    </div>

    <div class="card lift" draggable="true" data-id="schedule-transaction">
        <h2><i class="fas fa-clock"></i> Schedule Transaction</h2>
        <input type="text" id="scheduleFromAccount" placeholder="From Account" readonly />
        <input type="text" id="scheduleToAccount" placeholder="To Account Number" />
        <input type="number" id="scheduleAmount" placeholder="Amount (₹)" />
        <input type="datetime-local" id="scheduleDate" placeholder="Scheduled Date" />
        <button class="btn" onclick="scheduleTransaction()"><i class="fas fa-calendar-plus"></i> Schedule</button>
    </div>

    <div class="card lift" draggable="true" data-id="transfer-by-phone">
        <h2><i class="fas fa-phone-alt"></i> Transfer by Phone</h2>
        <input type="text" id="recipientPhone" placeholder="Recipient Phone Number" />
        <button class="btn" onclick="verifyRecipient()"><i class="fas fa-user-check"></i> Verify Recipient</button>
        <p><strong>Recipient Name:</strong> <span id="recipientName">-</span></p>
        <p><strong>Recipient Account:</strong> <span id="recipientAccount">-</span></p>
        <input type="number" id="phoneTransferAmount" placeholder="Amount (₹)" />
        <button class="btn" onclick="transferByPhone()"><i class="fas fa-paper-plane"></i> Transfer by Phone</button>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay"></div>

<div class="transaction-card" id="transactionCard">
    <button class="btn close-btn" onclick="closeTransactionCard()">
        <i class="fas fa-times"></i> Close
    </button>
    <h2><i class="fas fa-file-invoice-dollar"></i> Transaction History</h2>
    <table class="transaction-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Transaction ID</th>
            <th>From Account</th>
            <th>To Account</th>
            <th>Amount (₹)</th>
            <th>Date</th>
            <th>Type</th>
            <th>Status</th>
        </tr>
        </thead>
        <tbody id="transactionTableBody"></tbody>
    </table>
    <div class="loading-bar-container" id="loadingBar">
        <div class="loading-bar"></div>
    </div>
    <button class="btn email-btn" onclick="emailTransactionHistory()">
        <i class="fas fa-envelope"></i> Send to Email
    </button>
    <button class="btn chart-btn" onclick="toggleChartType()">
        <i class="fas fa-chart-pie"></i> Toggle Chart
    </button>
    <canvas id="transactionChart"></canvas>
</div>

<div class="notification" id="notification">
    <span id="notificationMessage"></span>
</div>

<div class="customization-panel" id="customizationPanel">
    <button class="btn close-btn" onclick="closeCustomizationPanel()">
        <i class="fas fa-times"></i> Close
    </button>
    <h2><i class="fas fa-cog"></i> Customize Dashboard</h2>
    <div class="flex space-x-2 mt-4">
        <div class="tab active" onclick="switchTab('theme')">Theme</div>
        <div class="tab" onclick="switchTab('layout')">Layout</div>
        <div class="tab" onclick="switchTab('accessibility')">Accessibility</div>
        <div class="tab" onclick="switchTab('notifications')">Notifications</div>
    </div>
    <div id="theme" class="tab-content active">
        <h3 class="text-lg font-semibold mt-4">Theme</h3>
        <select id="themeSelect" onchange="previewTheme()">
            <option value="dark">Dark (Default)</option>
            <option value="light">Light</option>
            <option value="blue">Blue</option>
            <option value="custom">Custom</option>
        </select>
        <div id="customThemeInputs" class="mt-2 hidden">
            <input type="color" id="primaryColor" value="#1f2937" onchange="previewCustomTheme()" />
            <label for="primaryColor">Primary Background</label>
            <input type="color" id="secondaryColor" value="#374151" onchange="previewCustomTheme()" />
            <label for="secondaryColor">Secondary Background</label>
            <input type="color" id="textColor" value="#e5e7eb" onchange="previewCustomTheme()" />
            <label for="textColor">Text Color</label>
            <input type="color" id="accentColor" value="#3b82f6" onchange="previewCustomTheme()" />
            <label for="accentColor">Accent Color</label>
        </div>
        <h3 class="text-lg font-semibold mt-4">Background Pattern</h3>
        <select id="bgPatternSelect" onchange="previewTheme()">
            <option value="gradient">Gradient</option>
            <option value="solid">Solid</option>
            <option value="grid">Subtle Grid</option>
        </select>
    </div>
    <div id="layout" class="tab-content">
        <h3 class="text-lg font-semibold mt-4">Card Visibility</h3>
        <div class="space-y-2">
            <label><input type="checkbox" id="show-account-details" checked onchange="toggleCard('account-details')"> Account Details</label>
            <label><input type="checkbox" id="show-current-balance" checked onchange="toggleCard('current-balance')"> Current Balance</label>
            <label><input type="checkbox" id="show-quick-actions" checked onchange="toggleCard('quick-actions')"> Quick Actions</label>
            <label><input type="checkbox" id="show-transfer-funds" checked onchange="toggleCard('transfer-funds')"> Transfer Funds</label>
            <label><input type="checkbox" id="show-mini-statement" checked onchange="toggleCard('mini-statement')"> Mini Statement</label>
            <label><input type="checkbox" id="show-schedule-transaction" checked onchange="toggleCard('schedule-transaction')"> Schedule Transaction</label>
            <label><input type="checkbox" id="show-transfer-by-phone" checked onchange="toggleCard('transfer-by-phone')"> Transfer by Phone</label>
        </div>
    </div>
    <div id="accessibility" class="tab-content">
        <h3 class="text-lg font-semibold mt-4">Font Size</h3>
        <select id="fontSizeSelect" onchange="previewFontSize()">
            <option value="14">Small (14px)</option>
            <option value="16" selected>Medium (16px)</option>
            <option value="18">Large (18px)</option>
        </select>
        <h3 class="text-lg font-semibold mt-4">Animation Speed</h3>
        <select id="animationSpeedSelect" onchange="previewAnimationSpeed()">
            <option value="0.2">Fast (0.2s)</option>
            <option value="0.3" selected>Normal (0.3s)</option>
            <option value="0.5">Slow (0.5s)</option>
        </select>
    </div>
    <div id="notifications" class="tab-content">
        <h3 class="text-lg font-semibold mt-4">In-App Notifications</h3>
        <label><input type="checkbox" id="enableNotifications" checked onchange="previewNotifications()"> Enable Notifications</label>
        <h3 class="text-lg font-semibold mt-4">Notification Duration</h3>
        <select id="notificationDurationSelect" onchange="previewNotifications()">
            <option value="3000">3 Seconds</option>
            <option value="5000" selected>5 Seconds</option>
            <option value="7000">7 Seconds</option>
        </select>
        <h3 class="text-lg font-semibold mt-4">Card Animation Effect</h3>
        <select id="cardAnimationSelect" onchange="previewCardAnimation()">
            <option value="lift" selected>Lift</option>
            <option value="scale">Scale</option>
            <option value="rotate">Rotate</option>
        </select>
        <h3 class="text-lg font-semibold mt-4">Card Border Style</h3>
        <select id="cardBorderStyleSelect" onchange="previewCardBorderStyle()">
            <option value="solid" selected>Solid</option>
            <option value="dashed">Dashed</option>
            <option value="none">None</option>
        </select>
    </div>
    <div class="flex space-x-2 mt-4">
        <button class="btn" onclick="savePreferences()">
            <i class="fas fa-save"></i> Save
        </button>
        <button class="btn" onclick="resetPreferences()">
            <i class="fas fa-undo"></i> Reset to Default
        </button>
    </div>
</div>

<script>
    const role = localStorage.getItem("role");
    const auth = localStorage.getItem("auth");

    if (!auth || role !== "customer") {
        window.location.href = "index.html";
    }

    let chartInstance = null;
    let currentChartType = 0;
    const chartTypes = ['pie', 'bar', 'line'];
    let saveTimeout = null;

    // Theme definitions
    const themes = {
        dark: {
            '--bg-primary': '#1f2937',
            '--bg-secondary': '#374151',
            '--nav-bg-start': '#111827',
            '--nav-bg-end': '#1e40af',
            '--text-color': '#e5e7eb',
            '--text-secondary': '#d1d5db',
            '--card-bg': '#1f2937',
            '--btn-start': '#3b82f6',
            '--btn-end': '#2563eb',
            '--btn-hover-start': '#2563eb',
            '--btn-hover-end': '#1e40af',
            '--border-color': '#4b5563',
            '--input-bg': '#374151',
            '--placeholder-color': '#9ca3af',
            '--accent-start': '#3b82f6',
            '--accent-end': '#10b981',
            '--balance-color': '#10b981',
            '--logout-bg': '#dc2626',
            '--email-btn-start': '#10b981',
            '--email-btn-end': '#059669',
            '--chart-btn-start': '#8b5cf6',
            '--chart-btn-end': '#6d28d9',
            '--table-header-bg': '#374151',
            '--table-row-hover': '#2d3748',
            '--tab-bg': '#374151',
            '--notification-bg': '#10b981',
            '--notification-text': '#ffffff'
        },
        light: {
            '--bg-primary': '#f3f4f6',
            '--bg-secondary': '#e5e7eb',
            '--nav-bg-start': '#ffffff',
            '--nav-bg-end': '#dbeafe',
            '--text-color': '#1f2937',
            '--text-secondary': '#4b5563',
            '--card-bg': '#ffffff',
            '--btn-start': '#3b82f6',
            '--btn-end': '#2563eb',
            '--btn-hover-start': '#2563eb',
            '--btn-hover-end': '#1e40af',
            '--border-color': '#d1d5db',
            '--input-bg': '#f9fafb',
            '--placeholder-color': '#9ca3af',
            '--accent-start': '#3b82f6',
            '--accent-end': '#10b981',
            '--balance-color': '#059669',
            '--logout-bg': '#dc2626',
            '--email-btn-start': '#10b981',
            '--email-btn-end': '#059669',
            '--chart-btn-start': '#8b5cf6',
            '--chart-btn-end': '#6d28d9',
            '--table-header-bg': '#e5e7eb',
            '--table-row-hover': '#f3f4f6',
            '--tab-bg': '#e5e7eb',
            '--notification-bg': '#10b981',
            '--notification-text': '#ffffff'
        },
        blue: {
            '--bg-primary': '#e0f2fe',
            '--bg-secondary': '#bae6fd',
            '--nav-bg-start': '#0284c7',
            '--nav-bg-end': '#0369a1',
            '--text-color': '#0c4a6e',
            '--text-secondary': '#075985',
            '--card-bg': '#f0f9ff',
            '--btn-start': '#0284c7',
            '--btn-end': '#0369a1',
            '--btn-hover-start': '#0369a1',
            '--btn-hover-end': '#075985',
            '--border-color': '#7dd3fc',
            '--input-bg': '#e0f2fe',
            '--placeholder-color': '#60a5fa',
            '--accent-start': '#0284c7',
            '--accent-end': '#10b981',
            '--balance-color': '#059669',
            '--logout-bg': '#dc2626',
            '--email-btn-start': '#10b981',
            '--email-btn-end': '#059669',
            '--chart-btn-start': '#8b5cf6',
            '--chart-btn-end': '#6d28d9',
            '--table-header-bg': '#bae6fd',
            '--table-row-hover': '#e0f2fe',
            '--tab-bg': '#bae6fd',
            '--notification-bg': '#10b981',
            '--notification-text': '#ffffff'
        }
    };

    const bgPatterns = {
        gradient: 'linear-gradient(135deg, var(--bg-primary), var(--bg-secondary))',
        solid: 'var(--bg-primary)',
        grid: `linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px),
               linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px)`
    };

    function applyTheme() {
        const themeSelect = document.getElementById("themeSelect").value;
        const customThemeInputs = document.getElementById("customThemeInputs");
        if (themeSelect === "custom") {
            customThemeInputs.classList.remove("hidden");
            applyCustomTheme();
        } else {
            customThemeInputs.classList.add("hidden");
            const theme = themes[themeSelect] || themes.dark;
            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(key, value);
            }
        }
        applyBgPattern();
    }

    function previewTheme() {
        applyTheme();
        debounceSave();
    }

    function applyCustomTheme() {
        const customTheme = {
            '--bg-primary': document.getElementById("primaryColor").value,
            '--bg-secondary': document.getElementById("secondaryColor").value,
            '--text-color': document.getElementById("textColor").value,
            '--accent-start': document.getElementById("accentColor").value,
            '--accent-end': document.getElementById("accentColor").value,
            '--nav-bg-start': document.getElementById("primaryColor").value,
            '--nav-bg-end': document.getElementById("secondaryColor").value,
            '--card-bg': document.getElementById("primaryColor").value,
            '--btn-start': document.getElementById("accentColor").value,
            '--btn-end': document.getElementById("accentColor").value,
            '--btn-hover-start': document.getElementById("accentColor").value,
            '--btn-hover-end': document.getElementById("accentColor").value,
            '--border-color': document.getElementById("secondaryColor").value,
            '--input-bg': document.getElementById("primaryColor").value,
            '--placeholder-color': document.getElementById("textColor").value,
            '--balance-color': document.getElementById("accentColor").value,
            '--logout-bg': '#dc2626',
            '--email-btn-start': document.getElementById("accentColor").value,
            '--email-btn-end': document.getElementById("accentColor").value,
            '--chart-btn-start': document.getElementById("accentColor").value,
            '--chart-btn-end': document.getElementById("accentColor").value,
            '--table-header-bg': document.getElementById("secondaryColor").value,
            '--table-row-hover': document.getElementById("primaryColor").value,
            '--tab-bg': document.getElementById("secondaryColor").value,
            '--notification-bg': document.getElementById("accentColor").value,
            '--notification-text': document.getElementById("textColor").value
        };
        for (const [key, value] of Object.entries(customTheme)) {
            document.documentElement.style.setProperty(key, value);
        }
    }

    function previewCustomTheme() {
        applyCustomTheme();
        debounceSave();
    }

    function applyBgPattern() {
        const pattern = document.getElementById("bgPatternSelect").value;
        const patternValue = bgPatterns[pattern];
        document.documentElement.style.setProperty('--bg-pattern', patternValue);
        if (pattern === 'grid') {
            document.body.style.backgroundSize = '20px 20px';
        } else {
            document.body.style.backgroundSize = 'auto';
        }
    }

    function previewFontSize() {
        const fontSize = document.getElementById("fontSizeSelect").value;
        document.documentElement.style.setProperty('--font-size', `${fontSize}px`);
        debounceSave();
    }

    function previewAnimationSpeed() {
        const speed = document.getElementById("animationSpeedSelect").value;
        document.documentElement.style.setProperty('--animation-speed', `${speed}s`);
        debounceSave();
    }

    function previewNotifications() {
        const enableNotifications = document.getElementById("enableNotifications").checked;
        const duration = document.getElementById("notificationDurationSelect").value;
        if (enableNotifications) {
            showNotification("Notification settings updated!", duration);
        }
        debounceSave();
    }

    function previewCardAnimation() {
        const animation = document.getElementById("cardAnimationSelect").value;
        applyCardAnimation(animation);
        debounceSave();
    }

    function applyCardAnimation(animation) {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            card.classList.remove('lift', 'scale', 'rotate');
            card.classList.add(animation);
        });
    }

    function previewCardBorderStyle() {
        const borderStyle = document.getElementById("cardBorderStyleSelect").value;
        document.documentElement.style.setProperty('--card-border-style', borderStyle);
        debounceSave();
    }

    function toggleCard(cardId) {
        const card = document.querySelector(`.card[data-id="${cardId}"]`);
        const checkbox = document.getElementById(`show-${cardId}`);
        if (checkbox.checked) {
            card.classList.remove("hidden");
        } else {
            card.classList.add("hidden");
        }
        debounceSave();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    function showNotification(message, duration) {
        const notification = document.getElementById("notification");
        const notificationMessage = document.getElementById("notificationMessage");
        if (!document.getElementById("enableNotifications").checked) return;
        notificationMessage.textContent = message;
        notification.classList.add("active");
        setTimeout(() => {
            notification.classList.remove("active");
        }, duration);
    }

    function debounceSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(savePreferences, 1000);
    }

    function savePreferences() {
        const themeSelect = document.getElementById("themeSelect").value;
        const fontSize = document.getElementById("fontSizeSelect").value;
        const animationSpeed = document.getElementById("animationSpeedSelect").value;
        const bgPattern = document.getElementById("bgPatternSelect").value;
        const cardOrder = Array.from(document.querySelectorAll('.card')).map(card => card.dataset.id);
        const cardVisibility = {
            'account-details': document.getElementById("show-account-details").checked,
            'current-balance': document.getElementById("show-current-balance").checked,
            'quick-actions': document.getElementById("show-quick-actions").checked,
            'transfer-funds': document.getElementById("show-transfer-funds").checked,
            'mini-statement': document.getElementById("show-mini-statement").checked,
            'schedule-transaction': document.getElementById("show-schedule-transaction").checked,
            'transfer-by-phone': document.getElementById("show-transfer-by-phone").checked
        };
        const transactionCardSize = {
            width: document.getElementById("transactionCard").style.width || '90%',
            height: document.getElementById("transactionCard").style.height || 'auto'
        };
        const notificationSettings = {
            enabled: document.getElementById("enableNotifications").checked,
            duration: document.getElementById("notificationDurationSelect").value
        };
        const cardAnimation = document.getElementById("cardAnimationSelect").value;
        const cardBorderStyle = document.getElementById("cardBorderStyleSelect").value;

        const preferences = {
            theme: themeSelect,
            fontSize: fontSize,
            animationSpeed: animationSpeed,
            bgPattern: bgPattern,
            cardOrder: cardOrder,
            cardVisibility: cardVisibility,
            transactionCardSize: transactionCardSize,
            notificationSettings: notificationSettings,
            cardAnimation: cardAnimation,
            cardBorderStyle: cardBorderStyle
        };

        if (themeSelect === "custom") {
            preferences.customTheme = {
                primaryColor: document.getElementById("primaryColor").value,
                secondaryColor: document.getElementById("secondaryColor").value,
                textColor: document.getElementById("textColor").value,
                accentColor: document.getElementById("accentColor").value
            };
        }

        localStorage.setItem("dashboardPreferences", JSON.stringify(preferences));
    }

    function resetPreferences() {
        localStorage.removeItem("dashboardPreferences");
        document.getElementById("themeSelect").value = "dark";
        document.getElementById("fontSizeSelect").value = "16";
        document.getElementById("animationSpeedSelect").value = "0.3";
        document.getElementById("bgPatternSelect").value = "gradient";
        document.getElementById("enableNotifications").checked = true;
        document.getElementById("notificationDurationSelect").value = "5000";
        document.getElementById("cardAnimationSelect").value = "lift";
        document.getElementById("cardBorderStyleSelect").value = "solid";
        document.querySelectorAll('.card').forEach(card => card.classList.remove("hidden"));
        document.querySelectorAll('.tab-content input[type="checkbox"]').forEach(checkbox => checkbox.checked = true);
        const transactionCard = document.getElementById("transactionCard");
        transactionCard.style.width = '90%';
        transactionCard.style.height = 'auto';
        applyTheme();
        applyFontSize();
        applyAnimationSpeed();
        applyBgPattern();
        applyCardAnimation("lift");
        document.documentElement.style.setProperty('--card-border-style', 'solid');
        const container = document.getElementById("mainContainer");
        const defaultOrder = ['account-details', 'current-balance', 'quick-actions', 'transfer-funds', 'mini-statement', 'schedule-transaction', 'transfer-by-phone'];
        const cards = Array.from(container.children);
        container.innerHTML = "";
        defaultOrder.forEach(id => {
            const card = cards.find(c => c.dataset.id === id);
            if (card) container.appendChild(card);
        });
        savePreferences();
        showNotification("Preferences reset to default!", 5000);
    }

    function loadPreferences() {
        const preferences = JSON.parse(localStorage.getItem("dashboardPreferences")) || {};
        if (preferences.theme) {
            document.getElementById("themeSelect").value = preferences.theme;
            if (preferences.theme === "custom" && preferences.customTheme) {
                document.getElementById("primaryColor").value = preferences.customTheme.primaryColor;
                document.getElementById("secondaryColor").value = preferences.customTheme.secondaryColor;
                document.getElementById("textColor").value = preferences.customTheme.textColor;
                document.getElementById("accentColor").value = preferences.customTheme.accentColor;
            }
            applyTheme();
        }
        if (preferences.fontSize) {
            document.getElementById("fontSizeSelect").value = preferences.fontSize;
            applyFontSize();
        }
        if (preferences.animationSpeed) {
            document.getElementById("animationSpeedSelect").value = preferences.animationSpeed;
            applyAnimationSpeed();
        }
        if (preferences.bgPattern) {
            document.getElementById("bgPatternSelect").value = preferences.bgPattern;
            applyBgPattern();
        }
        if (preferences.cardOrder) {
            const container = document.getElementById("mainContainer");
            const cards = Array.from(container.children);
            container.innerHTML = "";
            preferences.cardOrder.forEach(id => {
                const card = cards.find(c => c.dataset.id === id);
                if (card) container.appendChild(card);
            });
        }
        if (preferences.cardVisibility) {
            for (const [cardId, visible] of Object.entries(preferences.cardVisibility)) {
                document.getElementById(`show-${cardId}`).checked = visible;
                toggleCard(cardId);
            }
        }
        if (preferences.transactionCardSize) {
            const transactionCard = document.getElementById("transactionCard");
            transactionCard.style.width = preferences.transactionCardSize.width;
            transactionCard.style.height = preferences.transactionCardSize.height;
        }
        if (preferences.notificationSettings) {
            document.getElementById("enableNotifications").checked = preferences.notificationSettings.enabled;
            document.getElementById("notificationDurationSelect").value = preferences.notificationSettings.duration;
        }
        if (preferences.cardAnimation) {
            document.getElementById("cardAnimationSelect").value = preferences.cardAnimation;
            applyCardAnimation(preferences.cardAnimation);
        }
        if (preferences.cardBorderStyle) {
            document.getElementById("cardBorderStyleSelect").value = preferences.cardBorderStyle;
            document.documentElement.style.setProperty('--card-border-style', preferences.cardBorderStyle);
        }
    }

    function applyFontSize() {
        const fontSize = document.getElementById("fontSizeSelect").value;
        document.documentElement.style.setProperty('--font-size', `${fontSize}px`);
    }

    function applyAnimationSpeed() {
        const speed = document.getElementById("animationSpeedSelect").value;
        document.documentElement.style.setProperty('--animation-speed', `${speed}s`);
    }

    function openCustomizationPanel() {
        document.getElementById("customizationPanel").classList.add("active");
        document.getElementById("modalOverlay").classList.add("active");
        document.getElementById("mainContainer").classList.add("blur", "disabled");
        document.getElementById("navbar").classList.add("blur", "disabled");
        document.getElementById("customizationPanel").focus();
    }

    function closeCustomizationPanel() {
        document.getElementById("customizationPanel").classList.remove("active");
        document.getElementById("modalOverlay").classList.remove("active");
        document.getElementById("mainContainer").classList.remove("blur", "disabled");
        document.getElementById("navbar").classList.remove("blur", "disabled");
        savePreferences();
        showNotification("Customization settings saved!", document.getElementById("notificationDurationSelect").value);
    }

    // Keyboard navigation for customization panel
    document.getElementById("customizationPanel").addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeCustomizationPanel();
    });

    // Drag and Drop Functionality
    document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('card')) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
        }
    });

    document.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('card')) {
            e.target.classList.remove('dragging');
            debounceSave();
        }
    });

    document.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    document.addEventListener('drop', (e) => {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        const draggedElement = document.querySelector(`.card[data-id="${draggedId}"]`);
        const dropTarget = e.target.closest('.card');
        if (dropTarget && draggedElement !== dropTarget) {
            const container = document.getElementById("mainContainer");
            const allCards = Array.from(container.children);
            const draggedIndex = allCards.indexOf(draggedElement);
            const targetIndex = allCards.indexOf(dropTarget);
            if (draggedIndex < targetIndex) {
                container.insertBefore(draggedElement, dropTarget.nextSibling);
            } else {
                container.insertBefore(draggedElement, dropTarget);
            }
            debounceSave();
        }
    });

    // Resize Functionality for Transaction Card
    document.getElementById("transactionCard").addEventListener('resize', () => {
        debounceSave();
    });

    function recenterCard() {
        const transactionCard = document.getElementById("transactionCard");
        transactionCard.style.position = 'fixed';
        transactionCard.style.top = '50%';
        transactionCard.style.left = '50%';
        transactionCard.style.transform = 'translate(-50%, -50%)';
        transactionCard.style.margin = '0';
    }

    function showTransactionCard() {
        const transactionCard = document.getElementById("transactionCard");
        const modalOverlay = document.getElementById("modalOverlay");
        const mainContainer = document.getElementById("mainContainer");
        const navbar = document.getElementById("navbar");

        transactionCard.classList.add("active");
        modalOverlay.classList.add("active");
        mainContainer.classList.add("blur", "disabled");
        navbar.classList.add("blur", "disabled");

        transactionCard.style.position = 'fixed';
        transactionCard.style.top = '50%';
        transactionCard.style.left = '50%';
        transactionCard.style.transform = 'translate(-50%, -50%)';
        transactionCard.style.margin = '0';
        transactionCard.focus();
        showNotification("Transaction history opened!", document.getElementById("notificationDurationSelect").value);
    }

    const resizeObserver = new ResizeObserver(() => {
        recenterCard();
    });
    resizeObserver.observe(document.getElementById("transactionCard"));

    function closeTransactionCard() {
        const transactionCard = document.getElementById("transactionCard");
        const modalOverlay = document.getElementById("modalOverlay");
        const mainContainer = document.getElementById("mainContainer");
        const navbar = document.getElementById("navbar");

        transactionCard.classList.remove("active");
        modalOverlay.classList.remove("active");
        mainContainer.classList.remove("blur", "disabled");
        navbar.classList.remove("blur", "disabled");
        document.getElementById("transactionChart").style.display = "none";
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
        savePreferences();
        showNotification("Transaction history closed!", document.getElementById("notificationDurationSelect").value);
    }

    document.getElementById("transactionCard").addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeTransactionCard();
    });

    function logout() {
        localStorage.clear();
        window.location.href = "index.html";
        showNotification("Logged out successfully!", document.getElementById("notificationDurationSelect").value);
    }

    async function initCustomerDashboard() {
        loadPreferences();
        const phone = localStorage.getItem("phone");
        const password = localStorage.getItem("password");

        if (!phone || !password) {
            console.warn("Phone or password not found in localStorage");
            window.location.href = "index.html";
            return;
        }

        const base64Auth = btoa(`${phone}:${password}`);
        localStorage.setItem("auth", base64Auth);

        try {
            const accResponse = await fetch("https://vault-cs0j.onrender.com/api/customers/account-number", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Basic ${base64Auth}`
                },
                body: JSON.stringify({
                    phoneNumber: phone,
                    password: password
                })
            });

            const text = await accResponse.text();
            console.log("📦 Raw Response Text:", text);

            let accData;
            try {
                accData = JSON.parse(text);
            } catch (err) {
                console.error("❌ Failed to parse JSON:", err);
                alert("Invalid response format from server.");
                window.location.href = "index.html";
                return;
            }

            console.log("✅ Parsed JSON:", accData);

            if (!accData.accountNumber) {
                console.error("❌ accountNumber missing in parsed JSON!");
                alert(accData.error || "Account number not found!");
                window.location.href = "index.html";
                return;
            }

            const accNum = accData.accountNumber;
            localStorage.setItem("accountNumber", accNum);
            loadCustomerDetails(accNum);
            loadScheduleFromAccount();
            showNotification("Dashboard initialized!", document.getElementById("notificationDurationSelect").value);
        } catch (error) {
            console.error("❌ Error during account number fetch:", error);
            alert("Error connecting to the server.");
            window.location.href = "index.html";
        }
    }

    function loadCustomerDetails(accNum) {
        const auth = localStorage.getItem("auth");

        fetch(`https://vault-cs0j.onrender.com/api/customers/${accNum}/details`, {
            method: "GET",
            headers: {
                "Authorization": `Basic ${auth}`
            }
        })
        .then(res => res.json())
        .then(data => {
            console.log("✅ Customer details:", data);
            if (data.bankAccountNumber) document.getElementById("accountNumber").textContent = data.bankAccountNumber;
            if (data.phoneNumber) document.getElementById("phone").textContent = data.phoneNumber;
            if (data.name) document.getElementById("name").textContent = data.name;
            if (data.email) document.getElementById("email").textContent = data.email;
        })
        .catch(error => {
            console.error("❌ Error fetching personal details:", error);
            alert("Failed to load personal details");
        });

        fetch(`https://vault-cs0j.onrender.com/api/customers/balance/${accNum}`, {
            method: "GET",
            headers: {
                "Authorization": `Basic ${auth}`
            }
        })
        .then(res => res.json())
        .then(balance => {
            console.log("✅ Balance response:", balance);
            const balValue = typeof balance === "object" ? balance.balance : balance;
            document.getElementById("balance").textContent = balValue ?? "N/A";
        })
        .catch(error => {
            console.error("❌ Error fetching balance:", error);
            alert("Failed to fetch balance");
        });
    }

    function deposit() {
        const amount = parseFloat(document.getElementById("amount").value);
        fetch("https://vault-cs0j.onrender.com/api/customers/deposit", {
            method: "POST",
            headers: {
                "Authorization": `Basic ${localStorage.getItem("auth")}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                accountNumber: localStorage.getItem("accountNumber"),
                amount: amount
            })
        })
        .then(res => res.text())
        .then(message => {
            alert(message);
            showNotification("Deposit initiated!", document.getElementById("notificationDurationSelect").value);
        })
        .then(() => location.reload());
    }

    function withdraw() {
        const amount = parseFloat(document.getElementById("amount").value);
        fetch("https://vault-cs0j.onrender.com/api/customers/withdraw", {
            method: "POST",
            headers: {
                "Authorization": `Basic ${localStorage.getItem("auth")}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                accountNumber: localStorage.getItem("accountNumber"),
                amount: amount
            })
        })
        .then(res => res.text())
        .then(message => {
            alert(message);
            showNotification("Withdrawal initiated!", document.getElementById("notificationDurationSelect").value);
        })
        .then(() => location.reload());
    }

    function transfer() {
        fetch("https://vault-cs0j.onrender.com/api/customers/transfer", {
            method: "POST",
            headers: {
                "Authorization": `Basic ${localStorage.getItem("auth")}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fromAccount: localStorage.getItem("accountNumber"),
                toAccount: document.getElementById("toAccount").value,
                amount: parseFloat(document.getElementById("transferAmount").value)
            })
        })
        .then(res => res.json())
        .then(invoice => {
            if (invoice.transactionId) {
                alert(`Transfer successful! Transaction ID: ${invoice.transactionId}`);
                showNotification("Transfer successful!", document.getElementById("notificationDurationSelect").value);
                location.reload();
            } else {
                alert(invoice);
                showNotification("Transfer failed!", document.getElementById("notificationDurationSelect").value);
            }
        });
    }

    async function verifyRecipient() {
        const phoneNumber = document.getElementById("recipientPhone").value;
        if (!phoneNumber) {
            alert("Please enter a recipient phone number.");
            showNotification("Recipient phone number required!", document.getElementById("notificationDurationSelect").value);
            return;
        }

        try {
            const response = await fetch("https://vault-cs0j.onrender.com/api/customers/verify-recipient", {
                method: "POST",
                headers: {
                    "Authorization": `Basic ${localStorage.getItem("auth")}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    phoneNumber: phoneNumber
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                alert(errorText || "Failed to verify recipient.");
                showNotification("Recipient verification failed!", document.getElementById("notificationDurationSelect").value);
                document.getElementById("recipientName").textContent = "-";
                document.getElementById("recipientAccount").textContent = "-";
                return;
            }

            const data = await response.json();
            document.getElementById("recipientName").textContent = data.name || "-";
            document.getElementById("recipientAccount").textContent = data.accountNumber || "-";
            showNotification("Recipient verified!", document.getElementById("notificationDurationSelect").value);
        } catch (error) {
            console.error("❌ Error verifying recipient:", error);
            alert("Error verifying recipient: " + error.message);
            showNotification("Error verifying recipient!", document.getElementById("notificationDurationSelect").value);
            document.getElementById("recipientName").textContent = "-";
            document.getElementById("recipientAccount").textContent = "-";
        }
    }

    async function transferByPhone() {
        const recipientPhone = document.getElementById("recipientPhone").value;
        const amount = parseFloat(document.getElementById("phoneTransferAmount").value);

        if (!recipientPhone || !amount) {
            alert("Please enter both recipient phone number and amount.");
            showNotification("Phone number and amount required!", document.getElementById("notificationDurationSelect").value);
            return;
        }

        try {
            const response = await fetch("https://vault-cs0j.onrender.com/api/customers/transfer-by-phone", {
                method: "POST",
                headers: {
                    "Authorization": `Basic ${localStorage.getItem("auth")}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    recipientPhoneNumber: recipientPhone,
                    amount: amount
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                alert(errorText || "Failed to transfer funds.");
                showNotification("Transfer by phone failed!", document.getElementById("notificationDurationSelect").value);
                return;
            }

            const invoice = await response.json();
            if (invoice.transactionId) {
                alert(`Transfer successful! Transaction ID: ${invoice.transactionId}`);
                showNotification("Transfer by phone successful!", document.getElementById("notificationDurationSelect").value);
                document.getElementById("recipientPhone").value = "";
                document.getElementById("phoneTransferAmount").value = "";
                document.getElementById("recipientName").textContent = "-";
                document.getElementById("recipientAccount").textContent = "-";
                location.reload();
            } else {
                alert(invoice.message || "Transfer failed.");
                showNotification("Transfer by phone failed!", document.getElementById("notificationDurationSelect").value);
            }
        } catch (error) {
            console.error("❌ Error transferring by phone:", error);
            alert("Error transferring funds: " + error.message);
            showNotification("Error transferring by phone!", document.getElementById("notificationDurationSelect").value);
        }
    }

    function fetchMiniStatement() {
        const accNum = localStorage.getItem("accountNumber");
        const auth = localStorage.getItem("auth");
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;

        if (!fromDate || !toDate) {
            alert("Please select both From Date and To Date.");
            showNotification("Date range required!", document.getElementById("notificationDurationSelect").value);
            return;
        }

        fetch("https://vault-cs0j.onrender.com/api/transactions/mini-statement", {
            method: "POST",
            headers: {
                "Authorization": `Basic ${auth}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                accountNumber: accNum,
                fromDate: fromDate,
                toDate: toDate
            })
        })
        .then(res => res.json())
        .then(data => {
            const tableBody = document.getElementById("transactionTableBody");
            tableBody.innerHTML = "";

            if (!Array.isArray(data) || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No transactions found.</td></tr>';
                showTransactionCard();
                document.getElementById("transactionChart").style.display = "none";
                recenterCard();
                showNotification("No transactions found!", document.getElementById("notificationDurationSelect").value);
                return;
            }

            data.forEach(tx => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${tx.id || '-'}</td>
                    <td>${tx.transactionId || '-'}</td>
                    <td>${tx.fromAccount || '-'}</td>
                    <td>${tx.toAccount || '-'}</td>
                    <td>₹${tx.amount ? tx.amount.toFixed(2) : '-'}</td>
                    <td>${tx.date || '-'}</td>
                    <td>${tx.type || '-'}</td>
                    <td>${tx.status || '-'}</td>
                `;
                tableBody.appendChild(row);
            });

            renderChart(data);
            showTransactionCard();
            recenterCard();
            showNotification("Mini statement fetched!", document.getElementById("notificationDurationSelect").value);
        })
        .catch(error => {
            console.error("❌ Error fetching mini statement:", error);
            alert("Failed to fetch mini statement");
            showNotification("Failed to fetch mini statement!", document.getElementById("notificationDurationSelect").value);
        });
    }

    function loadScheduleFromAccount() {
        const accNum = localStorage.getItem("accountNumber");
        if (accNum) {
            document.getElementById("scheduleFromAccount").value = accNum;
        }
    }

    async function scheduleTransaction() {
        const fromAccount = document.getElementById("scheduleFromAccount").value;
        const toAccount = document.getElementById("scheduleToAccount").value;
        const amount = parseFloat(document.getElementById("scheduleAmount").value);
        const scheduledDateInput = document.getElementById("scheduleDate").value;

        if (!toAccount || !amount || !scheduledDateInput) {
            alert("Please fill in all fields.");
            showNotification("All fields required!", document.getElementById("notificationDurationSelect").value);
            return;
        }

        const date = new Date(scheduledDateInput);
        const formattedDate = date.toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        }).replace(/,/, '').replace(/(\d+)\/(\d+)\/(\d+)/, '$3-$1-$2');

        const payload = {
            fromAccount: fromAccount,
            toAccount: toAccount,
            amount: amount,
            scheduledDate: formattedDate
        };

        console.log("📤 Sending payload:", JSON.stringify(payload, null, 2));

        try {
            const response = await fetch("https://vault-cs0j.onrender.com/api/scheduled/create", {
                method: "POST",
                headers: {
                    "Authorization": `Basic ${localStorage.getItem("auth")}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            console.log("📥 Response status:", response.status, "Status text:", response.statusText);

            if (!response.ok) {
                const errorText = await response.text();
                console.error("❌ Error response:", errorText);
                throw new Error(errorText || "Failed to schedule transaction");
            }

            const result = await response.json();
            console.log("✅ Response data:", result);

            if (result && result.id) {
                alert(`Transaction scheduled successfully! ID: ${result.id}`);
                showNotification(`Transaction scheduled! ID: ${result.id}`, document.getElementById("notificationDurationSelect").value);
            } else {
                console.warn("⚠️ No ID in response:", result);
                alert("Transaction scheduled, but no ID returned by server.");
                showNotification("Transaction scheduled!", document.getElementById("notificationDurationSelect").value);
            }

            document.getElementById("scheduleToAccount").value = "";
            document.getElementById("scheduleAmount").value = "";
            document.getElementById("scheduleDate").value = "";
        } catch (error) {
            console.error("❌ Error scheduling transaction:", error);
            alert(`Error scheduling transaction: ${error.message}`);
            showNotification("Error scheduling transaction!", document.getElementById("notificationDurationSelect").value);
        }
    }

    async function emailTransactionHistory() {
        const accNum = localStorage.getItem("accountNumber");
        const auth = localStorage.getItem("auth");
        const email = document.getElementById("email").textContent;
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;
        const loadingBar = document.getElementById("loadingBar");

        if (!email) {
            alert("Email address not found. Please ensure account details are loaded.");
            showNotification("Email address not found!", document.getElementById("notificationDurationSelect").value);
            return;
        }

        if (!fromDate || !toDate) {
            alert("Please select both From Date and To Date.");
            showNotification("Date range required!", document.getElementById("notificationDurationSelect").value);
            return;
        }

        loadingBar.style.display = "block";

        try {
            const response = await fetch("https://vault-cs0j.onrender.com/api/transactions/mini-statement", {
                method: "POST",
                headers: {
                    "Authorization": `Basic ${auth}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    accountNumber: accNum,
                    fromDate: fromDate,
                    toDate: toDate
                })
            });

            if (!response.ok) {
                throw new Error("Failed to fetch transaction history");
            }

            const transactions = await response.json();

            if (!Array.isArray(transactions) || transactions.length === 0) {
                alert("No transactions found for the selected date range.");
                showNotification("No transactions found!", document.getElementById("notificationDurationSelect").value);
                loadingBar.style.display = "none";
                return;
            }

            const headers = ["ID", "Transaction ID", "From Account", "To Account", "Amount (₹)", "Date", "Type", "Status"];
            const csvRows = [
                headers.join(","),
                ...transactions.map(tx => [
                    tx.id || "-",
                    tx.transactionId || "-",
                    tx.fromAccount || "-",
                    tx.toAccount || "-",
                    tx.amount ? tx.amount.toFixed(2) : "-",
                    tx.date || "-",
                    tx.type || "-",
                    tx.status || "-"
                ].map(field => `"${field}"`).join(","))
            ];
            const csvContent = csvRows.join("\n");

            const emailResponse = await fetch("https://vault-cs0j.onrender.com/api/customers/email-transaction-history", {
                method: "POST",
                headers: {
                    "Authorization": `Basic ${auth}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    accountNumber: accNum,
                    email: email,
                    csvContent: csvContent,
                    fromDate: fromDate,
                    toDate: toDate
                })
            });

            if (!emailResponse.ok) {
                throw new Error("Failed to send email");
            }

            const result = await emailResponse.json();
            alert(result.message || "Transaction history emailed successfully!");
            showNotification("Transaction history emailed!", document.getElementById("notificationDurationSelect").value);
        } catch (error) {
            console.error("❌ Error emailing transaction history:", error);
            alert(`Error emailing transaction history: ${error.message}`);
            showNotification("Error emailing transaction history!", document.getElementById("notificationDurationSelect").value);
        } finally {
            loadingBar.style.display = "none";
        }
    }

    function renderChart(transactions) {
        const ctx = document.getElementById("transactionChart").getContext("2d");
        document.getElementById("transactionChart").style.display = "block";

        if (chartInstance) {
            chartInstance.destroy();
        }

        const typeCounts = transactions.reduce((acc, tx) => {
            const type = tx.type || 'Unknown';
            acc[type] = (acc[type] || 0) + 1;
            return acc;
        }, {});

        const labels = Object.keys(typeCounts);
        const data = Object.values(typeCounts);

        const amounts = transactions.map(tx => tx.amount || 0);
        const bins = [0, 1000, 5000, 10000, 50000, Infinity];
        const histogramData = bins.slice(0, -1).map((bin, i) => {
            return amounts.filter(amount => amount >= bin && amount < bins[i + 1]).length;
        });

        const chartType = chartTypes[currentChartType];
        let chartConfig;

        if (chartType === 'pie') {
            chartConfig = {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderColor: 'var(--card-bg, #1f2937)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-color, #e5e7eb)' } },
                        title: {
                            display: true,
                            text: 'Transactions by Type',
                            color: 'var(--text-color, #e5e7eb)',
                            font: { size: 16 }
                        }
                    }
                }
            };
        } else if (chartType === 'bar') {
            chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Transactions',
                        data: data,
                        backgroundColor: 'var(--accent-start, #3b82f6)',
                        borderColor: 'var(--accent-end, #2563eb)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'var(--text-color, #e5e7eb)' },
                            grid: { color: 'var(--border-color, #4b5563)' }
                        },
                        x: {
                            ticks: { color: 'var(--text-color, #e5e7eb)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'var(--text-color, #e5e7eb)' } },
                        title: {
                            display: true,
                            text: 'Transactions by Type',
                            color: 'var(--text-color, #e5e7eb)',
                            font: { size: 16 }
                        }
                    }
                }
            };
        } else if (chartType === 'line') {
            chartConfig = {
                type: 'line',
                data: {
                    labels: bins.slice(0, -1).map((bin, i) => `${bin}-${bins[i + 1] === Infinity ? '+' : bins[i + 1]}`),
                    datasets: [{
                        label: 'Transaction Amount Distribution',
                        data: histogramData,
                        borderColor: 'var(--accent-start, #3b82f6)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'var(--text-color, #e5e7eb)' },
                            grid: { color: 'var(--border-color, #4b5563)' }
                        },
                        x: {
                            ticks: { color: 'var(--text-color, #e5e7eb)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'var(--text-color, #e5e7eb)' } },
                        title: {
                            display: true,
                            text: 'Transaction Amount Distribution',
                            color: 'var(--text-color, #e5e7eb)',
                            font: { size: 16 }
                        }
                    }
                }
            };
        }

        chartInstance = new Chart(ctx, chartConfig);
    }

    function toggleChartType() {
        currentChartType = (currentChartType + 1) % chartTypes.length;
        const tableBody = document.getElementById("transactionTableBody");
        if (tableBody.children.length > 0 && tableBody.children[0].children[0].textContent !== 'No transactions found.') {
            fetchMiniStatement();
        }
        showNotification(`Chart type changed to ${chartTypes[currentChartType]}!`, document.getElementById("notificationDurationSelect").value);
    }

    // Initialize dashboard
    initCustomerDashboard();
</script>
</body>
</html>
